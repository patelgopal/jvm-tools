<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Java Virtual Machine Analyzer</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f6fa;
        color: #333;
        margin: 0;
        padding: 0;
    }

    main {
        max-width: 800px;
        margin: 40px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
        text-align: center;
        color: #2f3640;
        margin-bottom: 30px;
    }

    form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .card-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .option-card {
        flex: 1 1 45%;
        min-width: 140px;
        background-color: #f1f2f6;
        padding: 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .option-card:hover {
        background-color: #dcdde1;
    }

    .option-card.selected {
        border: 2px solid #40739e;
        background-color: #d1d8e0;
    }

    input[type="radio"] {
        transform: scale(1.2);
    }

    .file-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-input-wrapper input[type="file"] {
        display: none;
    }

    .file-input-label {
        padding: 10px 18px;
        background-color: #40739e;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .file-input-label:hover {
        background-color: #273c75;
    }

    #fileName {
        font-size: 0.9rem;
        color: #2f3640;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    button {
        margin-top: 20px;
        padding: 12px 20px;
        font-size: 1rem;
        background-color: #40739e;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button:disabled {
        background-color: #7f8fa6;
        cursor: not-allowed;
    }

    @media (max-width: 600px) {
        .option-card {
            flex: 1 1 100%;
        }
    }
</style>
</head>
<body>
<main>
<h1>Java Virtual Machine Analyzer</h1>

<form id="analyzerForm" action="/" method="post" enctype="multipart/form-data">

    <p><strong>Select the data to analyze:</strong></p>

    <!-- Top row: Heap / GC -->
    <div class="card-row">
        <label class="option-card" data-type="HEAP">
            <input type="radio" name="radiotype" value="HEAP">
            Heap Dump
        </label>

        <label class="option-card" data-type="GC">
            <input type="radio" name="radiotype" value="GC">
            GC Log
        </label>
    </div>

    <!-- Bottom row: Thread / LogReaper / GoAccess -->
    <div class="card-row">
        <label class="option-card" data-type="THREAD">
            <input type="radio" name="radiotype" value="THREAD">
            Thread Dump
        </label>

        <label class="option-card" data-type="LOG">
            <input type="radio" name="radiotype" value="LOG">
            Log Analyzer (LogReaper)
        </label>

        <label class="option-card" data-type="GOACCESS">
            <input type="radio" name="radiotype" value="GOACCESS">
            GoAccess
        </label>
    </div>

    <!-- File input (enabled only for HEAP/GC or GoAccess) -->
    <div class="file-input-wrapper">
        <label class="file-input-label" for="fileInput">Choose File</label>
        <input type="file" id="fileInput" name="file">
        <span id="fileName">No file chosen</span>
    </div>

    <button type="submit" id="submitBtn">Submit</button>
</form>
</main>

<script>
const fileInput = document.getElementById('fileInput');
const submitBtn = document.getElementById('submitBtn');
const fileNameSpan = document.getElementById('fileName');
const optionCards = document.querySelectorAll('.option-card');
const radios = document.querySelectorAll('input[type="radio"]');

function resetFileInput() {
    fileInput.value = '';
    fileNameSpan.textContent = 'No file chosen';
}

function clearSelection() {
    optionCards.forEach(c => c.classList.remove('selected'));
}

function clearRadios() {
    radios.forEach(r => r.checked = false);
}

function resetForm() {
    resetFileInput();
    submitBtn.disabled = true;
    fileInput.disabled = true;
    clearSelection();
    clearRadios();
}

// Handle file input change
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        fileNameSpan.textContent = fileInput.files[0].name;
    } else {
        fileNameSpan.textContent = 'No file chosen';
    }
});

// Handle radio selection
optionCards.forEach(card => {
    card.addEventListener('click', () => {
        const value = card.dataset.type;
        resetFileInput();
        clearSelection();
        card.classList.add('selected');

        if (value === 'HEAP' || value === 'GC' || value === 'GOACCESS') {
            fileInput.disabled = false;
            submitBtn.disabled = false;
        } else {
            fileInput.disabled = true;
            submitBtn.disabled = true;
        }

        if (value === 'THREAD') {
            window.location.href = '/thread';
        } else if (value === 'LOG') {
            window.location.href = 'http://localhost:8180/labs/logreaper';
        }
    });
});

// Handle form submission
document.getElementById('analyzerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const selected = document.querySelector('input[name="radiotype"]:checked');
    if (!selected) return;

    const type = selected.value;

    if (type === 'GOACCESS') {
        if (fileInput.files.length === 0) {
            alert('Please choose a log file for GoAccess.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]); // upload actual file content
        formData.append('fileName', fileInput.files[0].name);

        try {
            const resp = await fetch('/goaccess/run', {
                method: 'POST',
                body: formData
            });

            const text = await resp.text();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            const link = tempDiv.querySelector('a');
            if (link) window.open(link.href, '_blank');
        } catch (err) {
            alert("Upload failed: " + err);
        } finally {
            resetForm();
        }
    } else {
        e.target.submit(); // default submit for HEAP/GC
        resetForm();
    }
});

// Reset form on load or back/forward navigation
window.addEventListener('pageshow', () => {
    resetForm();
});
</script>
</body>
</html>
